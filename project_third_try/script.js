// üìö –ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥
const books = [
  {
    id: "master-i-margarita",
    title: "–ú–∞—Å—Ç–µ—Ä –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞",
    author: "–ú–∏—Ö–∞–∏–ª –ë—É–ª–≥–∞–∫–æ–≤",
    year: 1967,
    genres: ["–†–æ–º–∞–Ω", "–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞"],
    rating: 4.8,
    cover: "images/images.jpg",
    description: [
      "–ñ–∞—Ä–∫–∏–º –º–∞–π—Å–∫–∏–º –≤–µ—á–µ—Ä–æ–º –ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –ø—Ä–∞–≤–ª–µ–Ω–∏—è –ú–ê–°–°–û–õ–ò–¢ –ú–∏—Ö–∞–∏–ª –ë–µ—Ä–ª–∏–æ–∑...",
      "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ë–µ—Ä–ª–∏–æ–∑ –∏ –ò–≤–∞–Ω –ë–µ–∑–¥–æ–º–Ω—ã–π —Å–æ—á–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å—É–º–∞—Å—à–µ–¥—à–∏–º...",
      "–¢–µ–º –≤—Ä–µ–º–µ–Ω–µ–º –í–æ–ª–∞–Ω–¥ —Å–æ —Å–≤–∏—Ç–æ–π –≤–µ—Å—å–º–∞ –Ω–µ–æ–±—ã—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –∏—Å—Å–ª–µ–¥—É—é—Ç..."
    ],
    excerpt: [
      "¬´–†—É–∫–æ–ø–∏—Å–∏ –Ω–µ –≥–æ—Ä—è—Ç¬ª ‚Äî –í–æ–ª–∞–Ω–¥.",
      "¬´–ß—Ç–æ –∂–µ —Ç—ã, –ò–≤–∞–Ω, –Ω–µ –≤–µ–∑—Ä–∏—Ç –≤ –¥—å—è–≤–æ–ª–∞?¬ª",
      "¬´–ö–∞–∂–¥–æ–º—É –≤–æ–∑–¥–∞—Å—Ç—Å—è –ø–æ –≤–µ—Ä–µ –µ–≥–æ¬ª."
    ],
    review: "–ë—É–ª–≥–∞–∫–æ–≤ —Å–æ–∑–¥–∞–ª –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ä–æ–º–∞–Ω, –∞ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫—É—é –ø—Ä–∏—Ç—á—É –æ –¥–æ–±—Ä–µ –∏ –∑–ª–µ.",
    link: "book.html?id=master-i-margarita"
  },
  {
    id: "prestuplenie-i-nakazanie",
    title: "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ",
    author: "–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π",
    year: 1866,
    genres: ["–†–æ–º–∞–Ω", "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è"],
    rating: 4.6,
    cover: "https://upload.wikimedia.org/wikipedia/commons/4/4b/Crimeandpunishmentcover.png",
    description: [
      "–ò—Å—Ç–æ—Ä–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞ –†–∞—Å–∫–æ–ª—å–Ω–∏–∫–æ–≤–∞, —Å–æ–≤–µ—Ä—à–∏–≤—à–µ–≥–æ —É–±–∏–π—Å—Ç–≤–æ –∏ –ø–µ—Ä–µ–∂–∏–≤–∞—é—â–µ–≥–æ –Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω—ã–µ –º—É–∫–∏."
    ],
    excerpt: [
      "¬´–¢–≤–∞—Ä—å –ª–∏ —è –¥—Ä–æ–∂–∞—â–∞—è –∏–ª–∏ –ø—Ä–∞–≤–æ –∏–º–µ—é?¬ª",
      "¬´–°—Ç—Ä–∞–¥–∞–Ω–∏–µ ‚Äî –≤–µ–ª–∏–∫–∞—è –≤–µ—â—å¬ª"
    ],
    review: "–ì–ª—É–±–æ–∫–æ–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π —Å–æ–≤–µ—Å—Ç–∏ –∏ –º–æ—Ä–∞–ª–∏.",
    link: "book.html?id=prestuplenie-i-nakazanie"
  },
  {
    id: "anna-karenina",
    title: "–ê–Ω–Ω–∞ –ö–∞—Ä–µ–Ω–∏–Ω–∞",
    author: "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π",
    year: 1877,
    genres: ["–†–æ–º–∞–Ω", "–ö–ª–∞—Å—Å–∏–∫–∞"],
    rating: 4.7,
    cover: "https://upload.wikimedia.org/wikipedia/commons/4/4e/Anna_Karenina_book_cover.jpg",
    description: [
      "–¢—Ä–∞–≥–∏—á–µ—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –ª—é–±–≤–∏ –ê–Ω–Ω—ã –ö–∞—Ä–µ–Ω–∏–Ω–æ–π –∏ –í—Ä–æ–Ω—Å–∫–æ–≥–æ –Ω–∞ —Ñ–æ–Ω–µ —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –∞—Ä–∏—Å—Ç–æ–∫—Ä–∞—Ç–∏–∏."
    ],
    excerpt: [
      "¬´–í—Å–µ —Å—á–∞—Å—Ç–ª–∏–≤—ã–µ —Å–µ–º—å–∏ –ø–æ—Ö–æ–∂–∏ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞...¬ª",
      "¬´–ï—Å–ª–∏ –∏—â–µ—à—å —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞ ‚Äî —Ç—ã –µ–≥–æ –Ω–µ –Ω–∞–π–¥—ë—à—å¬ª"
    ],
    review: "–û–¥–∏–Ω –∏–∑ –≤–µ–ª–∏—á–∞–π—à–∏—Ö —Ä–æ–º–∞–Ω–æ–≤ –æ –ª—é–±–≤–∏, —Å–µ–º—å–µ –∏ –æ–±—â–µ—Å—Ç–≤–µ.",
    link: "book.html?id=anna-karenina"
  }
];

// üîç –ü–æ–ª—É—á–µ–Ω–∏–µ ID –∏–∑ URL
function getBookIdFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

// üîé –ü–æ–∏—Å–∫ –∫–Ω–∏–≥–∏ –ø–æ ID
function findBookById(id) {
  return books.find(book => book.id === id);
}

// üìò –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–Ω–∏–≥–∏
function renderBookPage(book) {
  const container = document.getElementById("book-page");

  container.innerHTML = `
    <div class="left_container">
      <img src="${book.cover}" alt="${book.title}" class="book_cover" />
      <div class="excerpt">
        <h2>–¶–∏—Ç–∞—Ç—ã –∏–∑ –∫–Ω–∏–≥–∏</h2>
        ${book.excerpt.map(line => `<p>${line}</p>`).join("")}
      </div>
    </div>

    <div class="right-container">
      <div class="upper-container">
        <h1>${book.title}</h1>
        <div class="meta">–ê–≤—Ç–æ—Ä: ${book.author} ‚Ä¢ –ì–æ–¥: ${book.year} ‚Ä¢ –û—Ü–µ–Ω–∫–∞: ${book.rating} ‚≠ê</div>
        <div class="quote">"${book.review}"</div>
        <div class="buttons">
          <button>–ß–∏—Ç–∞—Ç—å —Å–µ–π—á–∞—Å</button>
          <button>–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
        </div>
      </div>
      <div class="book-description">
        ${Array.isArray(book.description)
      ? book.description.map(p => `<p>${p}</p>`).join("")
      : `<p>${book.description}</p>`}
      </div>
    </div>
  `;
}

// üìö –ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥
function renderCatalogCards(books) {
  const bookList = document.getElementById("bookList");
  bookList.classList.add("book-list");

  books.forEach(book => {
    const card = document.createElement("a");
    card.className = "book-card";
    card.href = book.link;

    card.innerHTML = `
      <img src="${book.cover}" alt="${book.title}" class="book-cover">
      <div class="book-info">
        <div class="book-title">${book.title}</div>
        <div class="book-meta">–ê–≤—Ç–æ—Ä: ${book.author}</div>
        <div class="book-meta">–ì–æ–¥: ${book.year}</div>
        <div class="book-meta">–ñ–∞–Ω—Ä—ã: ${book.genres.join(", ")}</div>
        <div class="book-meta">–û—Ü–µ–Ω–∫–∞: ${book.rating} ‚≠ê</div>
        <div class="book-description">
          ${Array.isArray(book.description)
        ? book.description.map(p => `<p>${p}</p>`).join("")
        : `<p>${book.description}</p>`}
        </div>
      </div>
    `;

    card.addEventListener("click", () => {
      localStorage.setItem("selectedBook", JSON.stringify(book));
    });

    bookList.appendChild(card);
  });
}

// üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–Ω–∏–≥–∏ (–ü–†–û–°–¢–ê–Ø –í–ï–†–°–ò–Ø)
function renderRecommendedBooks() {
  const recommendedGrid = document.getElementById('recommendedBooks');

  // –ü—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º –≤—Å–µ –∫–Ω–∏–≥–∏ (–∏–ª–∏ –º–æ–∂–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å)
  const recommendedBooks = books; // –≤—Å–µ –∫–Ω–∏–≥–∏

  recommendedBooks.forEach(book => {
    const card = document.createElement("div");
    card.className = "new_release_card";
    card.style.backgroundColor = "#2a2a2a"; // —Ç–æ—Ç –∂–µ —Ü–≤–µ—Ç
    card.setAttribute("data-book-id", book.id); // –î–æ–±–∞–≤–ª—è–µ–º ID –∫–Ω–∏–≥–∏
    card.style.cursor = "pointer"; // –î–µ–ª–∞–µ–º –∫—É—Ä—Å–æ—Ä —É–∫–∞–∑–∞—Ç–µ–ª–µ–º

    card.innerHTML = `
      <img src="${book.cover}" alt="${book.title}" class="new_release_cover">
      <div class="new_release_info">
        <div class="new_release_title">${book.title}</div>
        <div class="new_release_rating">–û—Ü–µ–Ω–∫–∞: ${book.rating} ‚≠ê</div>
      </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
    card.addEventListener("click", () => {
      localStorage.setItem("selectedBook", JSON.stringify(book));
      window.location.href = book.link;
    });

    recommendedGrid.appendChild(card);
  });
}

// üè† –ù–æ–≤–∏–Ω–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
function renderMainCards(featuredBooks) {
  const container = document.getElementById("mainFeatured");

  featuredBooks.forEach(book => {
    const card = document.createElement("div");
    card.className = "new_release_card";
    card.style.backgroundColor = book.bgColor;
    card.setAttribute("data-book-id", book.id); // –î–æ–±–∞–≤–ª—è–µ–º ID –∫–Ω–∏–≥–∏
    card.style.cursor = "pointer"; // –î–µ–ª–∞–µ–º –∫—É—Ä—Å–æ—Ä —É–∫–∞–∑–∞—Ç–µ–ª–µ–º

    card.innerHTML = `
      <img src="${book.cover}" alt="${book.title}" class="new_release_cover">
      <div class="new_release_info">
        <div class="new_release_title">${book.title}</div>
        <div class="new_release_rating">–û—Ü–µ–Ω–∫–∞: ${book.rating} ‚≠ê</div>
      </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
    card.addEventListener("click", () => {
      // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ –ø–æ ID
      const fullBook = books.find(b => b.id === book.id);
      if (fullBook) {
        localStorage.setItem("selectedBook", JSON.stringify(fullBook));
        window.location.href = fullBook.link;
      }
    });

    container.appendChild(card);
  });
}

// üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
// üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener("DOMContentLoaded", () => {
  if (document.getElementById("bookList")) {
    renderCatalogCards(books);
  }

  if (document.getElementById("mainFeatured")) {
    const featuredBooks = books.map(book => ({
      id: book.id, // –î–æ–±–∞–≤–ª—è–µ–º ID –¥–ª—è —Å–≤—è–∑–∏
      title: book.title,
      rating: book.rating,
      cover: book.cover,
      bgColor: "#2a2a2a"
    }));
    renderMainCards(featuredBooks);
  }

  if (document.getElementById("recommendedBooks")) {
    renderRecommendedBooks();
  }

  if (document.getElementById("book-page")) {
    const bookId = getBookIdFromURL();
    const book = findBookById(bookId) || JSON.parse(localStorage.getItem("selectedBook"));

    if (book) {
      renderBookPage(book);
      // ‚úÖ –í–ê–ñ–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∏—Ç–∞–ª–∫—É –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–Ω–∏–≥–∏
      setTimeout(initOnlineReader, 100);
    } else {
      document.getElementById("book-page").innerHTML = "<p>–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>";
    }
  }
});




// üìñ –û–Ω–ª–∞–π–Ω-—á–∏—Ç–∞–ª–∫–∞
function initOnlineReader() {
  const readButtons = document.querySelectorAll('.buttons button:first-child');
  const onlineReader = document.getElementById('onlineReader');
  const closeReader = document.getElementById('closeReader');
  const readerTitle = document.getElementById('readerTitle');
  const readerText = document.getElementById('readerText');
  const prevPage = document.getElementById('prevPage');
  const nextPage = document.getElementById('nextPage');
  const pageInfo = document.getElementById('pageInfo');
  const fontSize = document.getElementById('fontSize');
  const darkMode = document.getElementById('darkMode');

  let currentBookId = null;
  let currentPage = 0;
  let isDarkMode = false;
  let bookPages = [];

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ß–∏—Ç–∞—Ç—å —Å–µ–π—á–∞—Å"
  readButtons.forEach(button => {
    button.addEventListener('click', function () {
      const bookId = getBookIdFromURL();
      currentBookId = bookId;
      openReader(bookId);
    });
  });

  async function openReader(bookId) {
    const book = findBookById(bookId);
    readerTitle.textContent = book.title;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    readerText.innerHTML = '<div style="text-align: center; padding: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏...</div>';
    onlineReader.classList.add('active');
    document.body.style.overflow = 'hidden';

    try {
      await loadBookText(bookId);
      currentPage = 0;
      showPage(0);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥–∏:', error);
      readerText.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3>${book.title}</h3>
                    <p><em>${book.author}</em></p>
                    <div style="margin-top: 20px;">
                        ${Array.isArray(book.description)
          ? book.description.map(p => `<p>${p}</p>`).join('')
          : `<p>${book.description}</p>`}
                    </div>
                    <p style="margin-top: 20px; color: #e74c3c;">
                        <em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–∏–≥–∏. –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.</em>
                    </p>
                </div>
            `;
    }
  }

  async function loadBookText(bookId) {
    try {
      // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
      const response = await fetch(`books/${bookId}.txt`);

      if (!response.ok) {
        throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }

      const text = await response.text();

      // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–∏–º–µ—Ä–Ω–æ 500 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É)
      bookPages = splitTextIntoPages(text, 1500);

      if (bookPages.length === 0) {
        throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
      }

    } catch (error) {
      throw error;
    }
  }

  function splitTextIntoPages(text, charsPerPage = 1500) {
    const pages = [];
    let start = 0;

    while (start < text.length) {
      let end = start + charsPerPage;

      // –ï—Å–ª–∏ –Ω–µ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞, –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π –∫–æ–Ω–µ—Ü –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
      if (end < text.length) {
        // –ò—â–µ–º —Ç–æ—á–∫—É, –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫
        const sentenceEnd = Math.max(
          text.lastIndexOf('.', end),
          text.lastIndexOf('!', end),
          text.lastIndexOf('?', end),
          text.lastIndexOf('\n\n', end)
        );

        if (sentenceEnd > start + charsPerPage * 0.3) {
          end = sentenceEnd + 1;
        }
      } else {
        end = text.length;
      }

      const pageText = text.substring(start, end).trim();
      if (pageText) {
        pages.push(pageText);
      }

      start = end;
    }

    return pages;
  }

  function showPage(pageNum) {
    if (bookPages[pageNum]) {
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç: –∑–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
      const formattedText = bookPages[pageNum]
        .split('\n\n')
        .map(paragraph => {
          if (paragraph.trim()) {
            return `<p style="text-indent: 1.5em; margin-bottom: 1em;">${paragraph.trim()}</p>`;
          }
          return '';
        })
        .join('');

      readerText.innerHTML = formattedText || '<p>–¢–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—É—Å—Ç</p>';
      currentPage = pageNum;
      updatePageInfo();
    }
  }

  function updatePageInfo() {
    pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage + 1} –∏–∑ ${bookPages.length}`;

    prevPage.disabled = currentPage === 0;
    nextPage.disabled = currentPage === bookPages.length - 1;
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  closeReader.addEventListener('click', () => {
    onlineReader.classList.remove('active');
    document.body.style.overflow = 'auto';
    bookPages = []; // –û—á–∏—â–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  });

  prevPage.addEventListener('click', () => {
    if (currentPage > 0) {
      showPage(currentPage - 1);
    }
  });

  nextPage.addEventListener('click', () => {
    if (currentPage < bookPages.length - 1) {
      showPage(currentPage + 1);
    }
  });

  fontSize.addEventListener('change', (e) => {
    readerText.style.fontSize = e.target.value + 'px';
  });

  darkMode.addEventListener('click', () => {
    isDarkMode = !isDarkMode;
    onlineReader.classList.toggle('reader-dark', isDarkMode);
    darkMode.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && onlineReader.classList.contains('active')) {
      onlineReader.classList.remove('active');
      document.body.style.overflow = 'auto';
      bookPages = [];
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
    if (onlineReader.classList.contains('active')) {
      if (e.key === 'ArrowLeft' && currentPage > 0) {
        showPage(currentPage - 1);
      } else if (e.key === 'ArrowRight' && currentPage < bookPages.length - 1) {
        showPage(currentPage + 1);
      }
    }
  });
}

